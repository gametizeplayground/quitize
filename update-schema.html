<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Database Schema</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>
<body>
    <h1>Database Schema Update</h1>
    <button id="update-btn" onclick="updateSchema()">Update Schema</button>
    <div id="output"></div>

    <script>
        async function updateSchema() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Checking and updating schema...</p>';
            
            try {
                // First, try to check current quiz_states table structure
                output.innerHTML += '<p>Checking current table structure...</p>';
                
                // Try to select from quiz_states to see what columns exist
                const { data: testData, error: testError } = await window.supabaseClient
                    .from('quiz_states')
                    .select('*')
                    .limit(1);
                
                if (testData || testError) {
                    output.innerHTML += '<p>Quiz states table exists. Checking columns...</p>';
                    
                    // Try a simple insert to test if columns exist
                    const testGameCode = 'TEST_' + Math.random().toString(36).substr(2, 9);
                    const { error: insertError } = await window.supabaseClient
                        .from('quiz_states')
                        .insert({
                            game_code: testGameCode,
                            phase: 'test',
                            countdown: 10,
                            time_left: 20
                        });
                    
                    if (insertError && insertError.message.includes('column')) {
                        output.innerHTML += '<p style="color: orange;">Missing columns detected. Adding them now...</p>';
                        
                        // Add missing columns using direct SQL
                        try {
                            // Add countdown column
                            const { error: e1 } = await window.supabaseClient.rpc('sql', {
                                query: 'ALTER TABLE quiz_states ADD COLUMN IF NOT EXISTS countdown INTEGER;'
                            });
                            
                            // Add time_left column  
                            const { error: e2 } = await window.supabaseClient.rpc('sql', {
                                query: 'ALTER TABLE quiz_states ADD COLUMN IF NOT EXISTS time_left INTEGER;'
                            });
                            
                            // Add start_time to game_sessions
                            const { error: e3 } = await window.supabaseClient.rpc('sql', {
                                query: 'ALTER TABLE game_sessions ADD COLUMN IF NOT EXISTS start_time TIMESTAMP WITH TIME ZONE;'
                            });
                            
                            if (e1 || e2 || e3) {
                                output.innerHTML += '<p style="color: red;">Error adding columns via RPC. Trying manual approach...</p>';
                                
                                // Manual approach - create a test function
                                await window.supabaseClient.rpc('create_missing_columns');
                            } else {
                                output.innerHTML += '<p style="color: green;">Columns added successfully!</p>';
                            }
                        } catch (rpcError) {
                            output.innerHTML += '<p style="color: red;">RPC method failed. Please run SQL manually in Supabase dashboard:</p>';
                            output.innerHTML += '<pre style="background: #f0f0f0; padding: 10px; margin: 10px 0;">ALTER TABLE quiz_states ADD COLUMN IF NOT EXISTS countdown INTEGER;\nALTER TABLE quiz_states ADD COLUMN IF NOT EXISTS time_left INTEGER;\nALTER TABLE game_sessions ADD COLUMN IF NOT EXISTS start_time TIMESTAMP WITH TIME ZONE;</pre>';
                        }
                    } else if (!insertError) {
                        output.innerHTML += '<p style="color: green;">All columns exist! Test insert successful.</p>';
                        // Clean up test record
                        await window.supabaseClient
                            .from('quiz_states')
                            .delete()
                            .eq('game_code', testGameCode);
                    } else {
                        output.innerHTML += `<p style="color: orange;">Insert test error: ${insertError.message}</p>`;
                    }
                }
                
                // Test the current quiz state functionality
                output.innerHTML += '<h3>Testing Quiz State Updates:</h3>';
                const testGameCode2 = 'FUNC_' + Math.random().toString(36).substr(2, 9);
                
                try {
                    // Test if GameDB.updateQuizState works
                    await GameDB.updateQuizState(testGameCode2, {
                        phase: 'question-preview',
                        currentQuestion: 0,
                        questionData: { title: 'Test Question' },
                        countdown: 10
                    });
                    
                    // Check if it was stored correctly
                    const { data: stored } = await window.supabaseClient
                        .from('quiz_states')
                        .select('*')
                        .eq('game_code', testGameCode2)
                        .single();
                    
                    if (stored) {
                        output.innerHTML += '<p style="color: green;">✅ Quiz state update test successful!</p>';
                        output.innerHTML += `<p>Stored data: ${JSON.stringify(stored, null, 2)}</p>`;
                        
                        // Clean up
                        await window.supabaseClient
                            .from('quiz_states')
                            .delete()
                            .eq('game_code', testGameCode2);
                    } else {
                        output.innerHTML += '<p style="color: red;">❌ Quiz state update test failed - no data stored</p>';
                    }
                } catch (funcError) {
                    output.innerHTML += `<p style="color: red;">❌ Quiz state function test failed: ${funcError.message}</p>`;
                }
                
            } catch (error) {
                console.error('Schema check error:', error);
                output.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
