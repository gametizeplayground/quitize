<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quitize - Join Game</title>
    <link rel="stylesheet" href="playerstyles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="assets/logo.png" alt="Quitize Logo" class="logo">
        </div>

        <!-- Game Code Entry Screen -->
        <div class="screen active" id="game-code-screen">
            <div class="main-content">
                <div class="mascot-container">
                    <div class="mascot">
                        <img src="assets/mascot.png" alt="Mascot" style="width: 200px; height: 200px;" />
                    </div>
                </div>

                <h1 class="welcome-text">Let's Play!</h1>

                <div class="form-container">
                    <input 
                        type="text" 
                        class="input-field" 
                        id="game-code-input" 
                        placeholder="Game Key"
                        maxlength="8"
                        autocomplete="off"
                    >
                    <button class="enter-button" id="enter-button" onclick="enterGameCode()">
                        Enter
                    </button>
                </div>

                <!-- Messages -->
                <div id="message-container"></div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Nickname Entry Screen -->
        <div class="screen" id="nickname-screen">
            <div class="main-content">
                <div class="mascot-container">
                    <div class="mascot">
                        <img src="assets/mascot2.png" alt="Mascot" style="width: 150px; height: 200px;" />
                    </div>
                </div>

                <h1 class="welcome-text">What's your name?</h1>

                <div class="form-container">
                    <input 
                        type="text" 
                        class="input-field" 
                        id="nickname-input" 
                        placeholder="Enter your name"
                        maxlength="20"
                        autocomplete="off"
                    >
                    <button class="join-button" id="join-button" onclick="joinGame()">
                        Join to the game!
                    </button>
                </div>

                <!-- Messages -->
                <div id="nickname-message-container"></div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Waiting Room Screen -->
        <div class="screen" id="waiting-room-screen">
            <div class="main-content">
                <div class="mascot-container">
                    <div class="mascot">
                        <img src="assets/mascot3.png" alt="Mascot">
                    </div>
                </div>
                
                <h1 class="welcome-text">Welcome!<br><span id="player-name-display">Player</span></h1>
                <p class="welcome-subtitle">Spot your name on the screen?</p>
                
                <div class="form-container">
                    <button class="leave-room-btn" onclick="leaveRoom()">
                        Leave the room
                    </button>
                </div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="screen" id="loading-screen">
            <div class="loading-screen-content">
                <h1 class="loading-title">Loading...</h1>
            </div>
            
            <div class="player-info">
                <span id="player-name-loading">Player</span>
                <div class="player-score" id="player-score-loading">0</div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Countdown Screen -->
        <div class="screen" id="countdown-screen">
            <div class="countdown-screen-content">
                <h1 class="quiz-title">Quiz 1</h1>
                <div class="countdown-number" id="countdown-display">5</div>
                <div class="countdown-mascot">
                    <img src="assets/getready_mascot.png" alt="Get Ready Mascot">
                </div>
            </div>

            <div class="player-info">
                <span id="player-name-info">Player</span>
                <div class="player-score" id="player-score-info">0</div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div class="screen" id="question-screen">
            <div class="question-screen-content">
                <h1 class="quiz-title">Quiz 1</h1>
                
                <div class="question-options">
                    <button class="option-button option-a" onclick="selectAnswer('A')">
                        A
                    </button>
                    <button class="option-button option-b" onclick="selectAnswer('B')">
                        B
                    </button>
                    <button class="option-button option-c" onclick="selectAnswer('C')">
                        C
                    </button>
                    <button class="option-button option-d" onclick="selectAnswer('D')">
                        D
                    </button>
                </div>
            </div>

            <div class="player-info">
                <span id="player-name-question">Player</span>
                <div class="player-score" id="player-score-question">0</div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="results-screen">
            <div class="results-screen-content">
                <h1 class="quiz-title">Quiz 1</h1>
                <div class="results-message" id="results-message">Great job!</div>
            </div>

            <div class="player-info">
                <span id="player-name-results">Player</span>
                <div class="player-score" id="player-score-results">0</div>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>

        <!-- Final Results Screen -->
        <div class="screen" id="final-results-screen">
            <div class="final-results-content">
                <h1 class="quiz-title">Game Over!</h1>
                <div class="final-score" id="final-score">Your final score: 0</div>
                <button class="play-again-btn" onclick="playAgain()">Play Again</button>
            </div>
            
            <div class="footer">
                <div class="footer-text">
                    Create your own game for FREE at quitize.com
                </div>
                <div class="footer-links">
                    <a href="#" class="footer-link">Terms</a>
                    <a href="#" class="footer-link">Privacy</a>
                    <a href="#" class="footer-link">Cookie Notice</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentGameCode = '';
        let playerName = '';
        let playerId = '';
        let currentScore = 0;
        let questionStartTime = 0;
        let heartbeatInterval = null;

        // Get game code from URL parameters
        function getGameCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }

        // Enter game code
        async function enterGameCode() {
            const gameCodeInput = document.getElementById('game-code-input');
            const code = gameCodeInput.value.trim().replace(/\s/g, ''); // Remove spaces
            
            if (code.length < 6) {
                showMessage('Please enter a valid game code', 'error');
                return;
            }

            try {
                // Check if game exists in Supabase
                const session = await GameDB.getGameSession(code);
                if (!session) {
                    showMessage('Game not found. Please check the code.', 'error');
                    return;
                }

                currentGameCode = code;
                showScreen('nickname-screen');
                
                // Initialize real-time subscriptions
                initializeGameSubscriptions(code);
                
            } catch (error) {
                console.error('Error checking game:', error);
                showMessage('Error connecting to game. Please try again.', 'error');
            }
        }

        // Join the game
        async function joinGame() {
            const nicknameInput = document.getElementById('nickname-input');
            const name = nicknameInput.value.trim();
            
            if (name.length < 2) {
                showMessage('Please enter a valid name (at least 2 characters)', 'error');
                return;
            }

            try {
                playerName = name;
                playerId = generatePlayerId();
                
                // Add player to game in Supabase
                await GameDB.addPlayer(currentGameCode, {
                    id: playerId,
                    name: playerName
                });
                
                // Start heartbeat to keep player presence alive
                startHeartbeat();
                
                showScreen('waiting-room-screen');
                updatePlayerDisplay();
                
            } catch (error) {
                console.error('Error joining game:', error);
                showMessage('Error joining game. Please try again.', 'error');
            }
        }

        // Generate unique player ID
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Start heartbeat to keep player presence alive
        function startHeartbeat() {
            // Send heartbeat every 5 seconds
            heartbeatInterval = setInterval(async () => {
                try {
                    if (playerId && currentGameCode) {
                        await GameDB.updatePlayerHeartbeat(currentGameCode, playerId);
                    }
                } catch (error) {
                    console.error('Error sending heartbeat:', error);
                }
            }, 5000);
        }

        // Stop heartbeat
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // Clean up player data
        async function cleanupPlayer() {
            stopHeartbeat();
            if (playerId && currentGameCode) {
                try {
                    await GameDB.removePlayer(currentGameCode, playerId);
                } catch (error) {
                    console.error('Error removing player:', error);
                }
            }
            cleanupSubscriptions();
        }

        // Leave the room
        async function leaveRoom() {
            await cleanupPlayer();
            window.location.href = 'player-online.html';
        }

        // Play again
        async function playAgain() {
            await cleanupPlayer();
            window.location.href = 'player-online.html';
        }

        // Show a specific screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Show message
        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // Update player display
        function updatePlayerDisplay() {
            const elements = [
                'player-name-display',
                'player-name-loading',
                'player-name-info',
                'player-name-question',
                'player-name-results'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = playerName;
                }
            });
        }

        // Update score display
        function updateScoreDisplay() {
            const elements = [
                'player-score-loading',
                'player-score-info',
                'player-score-question',
                'player-score-results'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = currentScore;
                }
            });
        }

        // Select answer
        async function selectAnswer(answer) {
            if (questionStartTime === 0) {
                questionStartTime = Date.now();
            }
            
            const timeTaken = Math.floor((Date.now() - questionStartTime) / 1000);
            
            try {
                // Submit answer to Supabase
                await GameDB.submitAnswer(currentGameCode, playerId, 0, answer, timeTaken);
                
                // Disable all buttons
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                });
                
                // Show results screen
                setTimeout(() => {
                    showScreen('results-screen');
                    updateScoreDisplay();
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting answer:', error);
                showMessage('Error submitting answer. Please try again.', 'error');
            }
        }

        // Handle quiz state updates
        function handleQuizStateUpdate(payload) {
            const { quizState } = payload.detail;
            
            switch (quizState.phase) {
                case 'countdown':
                    showScreen('loading-screen');
                    updatePlayerDisplay();
                    updateScoreDisplay();
                    break;
                    
                case 'question-preview':
                    showScreen('countdown-screen');
                    updatePlayerDisplay();
                    updateScoreDisplay();
                    break;
                    
                case 'live-question':
                    showScreen('question-screen');
                    updatePlayerDisplay();
                    updateScoreDisplay();
                    questionStartTime = Date.now();
                    break;
                    
                case 'results':
                    showScreen('results-screen');
                    updatePlayerDisplay();
                    updateScoreDisplay();
                    break;
                    
                case 'scoreboard':
                    showScreen('loading-screen');
                    updatePlayerDisplay();
                    updateScoreDisplay();
                    break;
                    
                case 'final-results':
                    showScreen('final-results-screen');
                    document.getElementById('final-score').textContent = `Your final score: ${currentScore}`;
                    break;
            }
        }

        // Handle game session updates
        function handleGameSessionUpdate(payload) {
            const { session } = payload.detail;
            
            if (session.scores && session.scores[playerName]) {
                currentScore = session.scores[playerName];
                updateScoreDisplay();
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            window.addEventListener('quizStateUpdated', handleQuizStateUpdate);
            window.addEventListener('gameSessionUpdated', handleGameSessionUpdate);
        }

        // Initialize the game
        function initializeGame() {
            // Check if game code is in URL
            const urlGameCode = getGameCodeFromURL();
            if (urlGameCode) {
                document.getElementById('game-code-input').value = urlGameCode;
                enterGameCode();
            }
            
            initializeEventListeners();
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', async function() {
            await cleanupPlayer();
        });

        // Clean up on page visibility change (mobile-friendly)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                // Stop heartbeat immediately when page is hidden
                stopHeartbeat();
                // The absence of heartbeat will cause cleanup within 15-23 seconds
            } else if (document.visibilityState === 'visible' && playerId && currentGameCode) {
                // Resume heartbeat when page becomes visible again
                startHeartbeat();
            }
        });

        // Initialize when page loads
        window.addEventListener('load', initializeGame);

        // Handle Enter key for game code input
        document.getElementById('game-code-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                enterGameCode();
            }
        });

        // Handle Enter key for nickname input
        document.getElementById('nickname-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinGame();
            }
        });
    </script>
</body>
</html> 